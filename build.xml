<project>

    <!-- This ant script is used to build and deploy flogo apps to a TIBCO Data Plane -->
    <property environment="env"/>

    <property name="base_url" value="${env.BASE_URL}"/>
    <property name="app_json" value="${env.APP_JSON}"/>
    <property name="target_os" value="${env.TARGET_OS}"/>
    <property name="target_arch" value="${env.TARGET_ARCH}"/>
    
    <property name="appid" value="${env.APP_ID}"/>
    <property name="token" value="${env.TOKEN}"/>

    <echo message="TOKEN: ${token}"/>
    <echo message="APP_ID: ${appid}"/>
    <echo message="BASE_URL ${base_url}"/>
    <echo message="APP_JSON: ${app_json}"/>
    <echo message="TARGET_OS: ${target_os}"/>
    <echo message="TARGET_ARCH: ${target_arch}"/>
    
    <target name="init">
    </target>

    <target name="clean">
    </target>


    <target name="build" depends="init">
        
        <fail message="TOKEN not set.">
            <condition>
                <not>
                    <isset property="env.TOKEN"/>
                </not>
            </condition>
        </fail>

        <fail message="BASE_URL not set.">
            <condition>
                <not>
                    <isset property="env.BASE_URL"/>
                </not>
            </condition>
        </fail>

        <fail message="APP_JSON not set.">
            <condition>
                <not>
                    <isset property="env.APP_JSON"/>
                </not>
            </condition>
        </fail>
        
        <fail message="TARGET_OS not set.">
            <condition>
                <not>
                    <isset property="env.TARGET_OS"/>
                </not>
            </condition>
        </fail>

        <fail message="TARGET_ARCH not set.">
            <condition>
                <not>
                    <isset property="env.TARGET_ARCH"/>
                </not>
            </condition>
        </fail>
           
        <echo message="Building Flogo application from source ${app_json}"/>
        
        <exec executable="curl">
            <arg value="-X" />
            <arg value="POST" />
            <arg value="https://${base_url}/v1/dp/builds?os=${target_os}&amp;arch=${target_arch}" />
            <arg value="--header" />
            <arg value="accept: application/json" />
            <arg value="--header" />
            <arg value="Content-Type: multipart/form-data" />        
            <arg value="--header" />
            <arg value="Authorization: Bearer ${token}" />
            <arg value="--form" />
            <arg value="app.json=@./src/${app_json}" />
            <arg value="--output" />
            <arg value="build.json" />
        </exec>

        <exec executable="jq" outputproperty="build_id">
            <arg value="--raw-output"/>
            <arg value=".buildId"/>
            <arg value="build.json"/>
        </exec>

        <echo message="Generated BUILD_ID: ${build_id}" />


    </target>



    <target name="deploy" depends="build">

        <fail message="TOKEN not set.">
            <condition>
                <not>
                    <isset property="env.TOKEN"/>
                </not>
            </condition>
        </fail>

        <exec executable="jq" outputproperty="build_id">
            <arg value="--raw-output"/>
            <arg value=".buildId"/>
            <arg value="build.json"/>
        </exec>

        <exec executable="curl">
            <arg value="-X" />
            <arg value="POST" />
            <arg value="https://${base_url}/v1/dp/builds/${build_id}/deploy" />
            <arg value="--header" />
            <arg value="accept: application/json" />
            <arg value="--header" />
            <arg value="Content-Type: application/json" />        
            <arg value="--header" />
            <arg value="Authorization: Bearer ${token}" />
            <arg value="--data" />
            <arg value="@./deploy/app-deploy.json" />
        </exec>

    </target>

    <target name="delete" depends="">

        <fail message="TOKEN not set.">
            <condition>
                <not>
                    <isset property="env.TOKEN"/>
                </not>
            </condition>
        </fail>

        <fail message="APP_ID not set.">
            <condition>
                <not>
                    <isset property="env.APP_ID"/>
                </not>
            </condition>
        </fail>


        <!-- Scale to 0 -->

        <exec executable="curl">
            <arg value="-X" />
            <arg value="PUT" />
            <arg value="https://${base_url}/v1/dp/apps/${app_id}/scale/0" />
            <arg value="--header" />
            <arg value="accept: application/json" />    
            <arg value="--header" />
            <arg value="Authorization: Bearer ${token}" />
        </exec>

        <exec executable="curl">
            <arg value="-X" />
            <arg value="DELETE" />
            <arg value="https://${base_url}/v1/dp/apps/${app_id}" />
            <arg value="--header" />
            <arg value="accept: application/json" />    
            <arg value="--header" />
            <arg value="Authorization: Bearer ${token}" />
        </exec>


    </target>

    <target name="all" depends="clean, build">
    </target>

</project>
